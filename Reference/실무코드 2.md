íƒœê·¸: #Reference

# ì‹¤ë¬´ì½”ë“œ - querydsl(ì½”í‹€ë¦° - ê±´ìš°ë‹˜ ì œê³µ)

## ğŸ’¡ Search API

ì¡°ê±´

- ìœ ì € ì„œë¹„ìŠ¤ì•ˆì— êµ¬í˜„ í•  ê²ƒ
- ìœ ì € ì»¨íŠ¸ë¡¤ëŸ¬ ì•ˆì— êµ¬í˜„ í•  ê²ƒ (ì–´ë“œë¯¼ë§Œ ì ‘ê·¼ ê°€ëŠ¥)
- ì„±ëŠ¥ì´ìŠˆë¥¼ ìƒê°í•´ ë³¼ ê²ƒ (ê²€ìƒ‰ ê¸°ëŠ¥ - ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ ë¿ë§Œ ì•„ë‹ˆë¼ SQL ì„±ëŠ¥ ê³ ë ¤) - ì‹¬í™”

<br>

í˜„ì¬ ì–´ë“œë¯¼ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ìœ ì € ë¦¬ìŠ¤íŠ¸ ê²€ìƒ‰ ê¸°ëŠ¥ì€ ì „ì²´ ìœ ì €ë¥¼ ê²€ìƒ‰í•œë‹¤.

- ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Paging ê¸°ëŠ¥ì„ ë„ì…í•´ í•œ ë²ˆì— 30ëª…ì˜ ìœ ì €ë¥¼ ê²€ìƒ‰ê°€ëŠ¥í•˜ê²Œ í•œë‹¤
  (ë‹¨ íŒŒë¼ë¯¸í„°ë¥¼ ì´ìš©í•´ 1í˜ì´ì§€, 2í˜ì´ì§€ë“± ê²€ìƒ‰ì´ ê°€ëŠ¥í•´ì•¼ í•œë‹¤)
  ì •íšŒì› / ë¶€íšŒì› / ì¤€íšŒì› ìˆœìœ¼ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•œ APIë¥¼ êµ¬í˜„í•œë‹¤
- ì „ì²´ ìœ ì €ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´ ìƒê¸°ëŠ” ê²€ìƒ‰ ê¸°ëŠ¥ì˜ ë¯¸ë¹„ë¥¼ ìœ„í•´ ìƒˆë¡œìš´ ê²€ìƒ‰ APIë¥¼ êµ¬í˜„í•œë‹¤ (GET)
  í•œ APIì—ì„œ êµ¬í˜„í•´ì•¼ í•˜ëŠ” ê²€ìƒ‰ ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ë‹¤ (AND ì¡°ê±´ ë° OR ì¡°ê±´ìœ¼ë¡œ êµ¬ë¶„í•  ê²ƒ)
  **ìœ ì € ì´ë©”ì¼**
  **ìœ ì € ë™ë¬¼ ì´ë¦„**
  **ìœ ì € ì´ë¦„**
  (ìœ„ ì¡°ê±´ì€ ì¶”ê°€ ë  ìˆ˜ ìˆë‹¤)
- ì¶”ê°€ í•„í„°ë§ì„ ìœ„í•´ íŒŒë¼ë¯¸í„°ê°€ ì•„ë‹Œ bodyë¡œ ë°›ëŠ” ê²ƒì„ ê³ ë ¤í•˜ëŠ” APIë¥¼ êµ¬ì¶•í•œë‹¤ (POST API)
  (ë‹¤ë‚˜ì™€ì˜ ê²€ìƒ‰ê¸°ëŠ¥ì„ í™•ì¸í•´ ë³¼ ê²ƒ) - ì‹¬í™”
  í˜ì´ì§•ì„ êµ¬í˜„í•˜ì—¬ ê²€ìƒ‰í•  ê²ƒ

---

### Admin Controller

```kotlin
    /** @desc íšŒì› ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ (í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©) */
    @GetMapping("/search")
    fun getAllUserByKeyword(
        @RequestBody data: SearchDTO
    ): ResponseEntity<List<UserSearchDTO>> {
        return ResponseEntity(userService.getAllUserByKeyword(data), HttpStatus.OK)
    }
```

---

### UserSearchDTO

```kotlin
@JsonInclude(JsonInclude.Include.NON_NULL)
data class UserSearchDTO(

    /** @desc í‚¤ì›Œë“œ ê²€ìƒ‰ ì¡°ê±´ */
    var keyword: String = "",
    var and: Boolean? = null,

    /** @desc ë°˜ë ¤ë™ë¬¼ ì •ë³´ */
    var animalName: String? = "",
    var animal: String? = "",
    var breed: String? = "",

    /** @desc ìœ ì € ì •ë³´ */
    var userName: String? = "",
    var userAgeRange: String? = "",
    var userGender: String? = "",
    var userLocation: String? = "",

    var userCreatedAt: LocalDateTime? = null,
    var userProfileAt: LocalDateTime? = null,
    var userRefreshedAt: LocalDateTime? = null,
    var email: String? = "",
) {
    object ModelMapper {
        fun entityToDto(form: User): UserSearchDTO {

            var animalName = ""
            var animal = ""
            var breed = ""

            var location = form.geometry.toString()

            if (form.animals.size != 0) {
                animalName = form.animals[0].name
                animal = form.animals[0].animal
                breed = form.animals[0].breed
            }
            return UserSearchDTO(
                animalName = animalName,
                animal = animal,
                breed = breed,

                userName = form.name,
                userAgeRange = form.ageRange,
                userGender = form.gender,
                userLocation = location,
                userCreatedAt = form.userDate?.createdAt,
                userProfileAt = form.userDate?.profileAt,
                userRefreshedAt = form.userToken?.tokenCreatedAt,
                email = form.email,
            )
        }
    }
}

@JsonInclude(JsonInclude.Include.NON_NULL)
data class UserSearchDetailDTO(

    /** í‚¤ì›Œë“œ ê²€ìƒ‰ ì¡°ê±´ */
    var keyword: String? = "",
    var and: Boolean? = null,

    /** @desc ë°˜ë ¤ë™ë¬¼ ì •ë³´ */
    var animalName: String? = "",
    var breed: String? = "",
    var animalAge: String? = "",
    var animal: String? = "",
    var animalNeutralization: Boolean? = null,

    var animalImages: List<String>? = listOf(),

    /** ìœ ì € ì •ë³´ */
    var userName: String? = "",
    var userAgeRange: String? = "",
    var trustPoint: Int? = 0,
    var give: Int? = 0,
    var take: Int? = 0,
    var userCreatedAt: LocalDateTime? = null,
    var userProfileAt: LocalDateTime? = null,
    var userRefreshedAt: LocalDateTime? = null,
    var userProfile: String? = "",
    var grade: String? = "",
    var sido: String? = "",
    var sigungu: String? = "",
    var dong: String? = "",
    var userLocation: String? = ""
) {
    companion object {
        fun fromEntity(form: User): UserSearchDetailDTO {

            var animalName = ""
            var breed = ""
            var animalAge = ""
            var animal = ""
            var animalNeutralization: Boolean? = null

            val location = form.geometry.toString()

            if (form.animals.size != 0) {
                animalName = form.animals[0].name
                breed = form.animals[0].breed
                animalAge = form.animals[0].getAge()
                animal = form.animals[0].animal
                animalNeutralization = form.animals[0].neutralization
            }

            return UserSearchDetailDTO(
                animalName = animalName,
                breed = breed,
                animalAge = animalAge,
                animal = animal,
                animalNeutralization = animalNeutralization,
                animalImages = form.userDetail?.animalImages,

                userName = form.name,
                userAgeRange = form.ageRange,
                trustPoint = form.trustPoint,
                give = form.give,
                take = form.take,
                userCreatedAt = form.userDate?.createdAt,
                userProfileAt = form.userDate?.profileAt,
                userRefreshedAt = form.userToken?.tokenCreatedAt,
                userProfile = form.userProfile,
                grade = form.grade,
                sido = form.geometry?.sido,
                sigungu = form.geometry?.sigungu,
                dong = form.geometry?.dong,
                userLocation = location
            )
        }
    }
}

data class SearchDTO(
    var userName: String? = "",
    var email: String? = "",
    var animalName: String? = "",
    var and: Boolean? = null

```

---

### User

UserService

```kotlin
    /** @desc ìœ ì € í‚¤ì›Œë“œ ê²€ìƒ‰ */
    fun getAllUserByKeyword(data: SearchDTO): List<UserSearchDTO> {

        val users = try {
            userRepository.findUserByKeyword(data.email, data.userName, data.animalName, data.and)
        } catch (e: Exception) {
            log.error("ìœ ì € ì •ë³´ ê²€ìƒ‰ ì‹¤íŒ¨ - [ ${data.email}, ${data.userName}, ${data.animalName}, ${data.and} - $e ]")
            throw CommonException("ìœ ì € ì •ë³´ ê²€ìƒ‰ ì‹¤íŒ¨", HttpStatus.BAD_REQUEST)
        }

        log.info("ìœ ì € ê²€ìƒ‰ ì™„ë£Œ - [ ê²°ê³¼ ìœ ì € ìˆ˜ : ${users!!.size} ]")

        return users.stream().map { UserSearchDTO.ModelMapper.entityToDto(it) }.toList()
    }
```

<br>

CustomUserRepository

```kotlin
fun findUserByKeyword(email: String?, userName: String?, animalName: String?, and: Boolean?): MutableList<User>?
```

<br>
CustomUserRepositoryImpl

```kotlin
    /**
     * @desc ìœ ì € ì „ì²´ ì¡°íšŒ(í•„í„°ë§) í‚¤ì›Œë“œ ê²€ìƒ‰
     * @fun findUserByKeyword & searchCondition
     */
    override fun findUserByKeyword(
        email: String?,
        userName: String?,
        animalName: String?,
        and: Boolean?
    ): MutableList<User>? {

        val paging = PageRequest.of(0, 30)

        val builder = searchCondition(email, userName, animalName, and)

        return queryFactory
            .selectFrom(user)
            .where(builder)
            .orderBy(user.userToken.tokenCreatedAt.desc())
            .offset(paging.offset).limit(30.toLong())
            .fetch()
    }

    fun searchCondition(
        email: String?,
        userName: String?,
        animalName: String?,
        and: Boolean?,
    ): BooleanBuilder {

        val builder = BooleanBuilder()

        fun eqUserName(userName: String?): BooleanExpression? {
            return if (userName.isNullOrEmpty()) null else user.name.contains(userName)
        }

        fun eqAnimalName(animalName: String?): BooleanExpression? {
            return if (animalName.isNullOrEmpty()) null else user.animals.any().name.contains(animalName)
        }

        fun eqEmail(email: String?): BooleanExpression? {
            return if (email.isNullOrEmpty()) null else user.email.contains(email)
        }

        if (and!!) builder.and(eqEmail(email)) else builder.or(eqEmail(email))

        if (and!!) builder.and(eqUserName(userName)) else builder.or(eqUserName(userName))

        if (and!!) builder.and(eqAnimalName(animalName)) else builder.or(eqAnimalName(animalName))

        return builder
    }
```

---

### ì™„ë£Œ

![image-20230420110603892](https://raw.githubusercontent.com/spacedustz/Typora-Image-Server/main/img/searchAPI_done.png)
