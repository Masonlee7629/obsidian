태그: #Reference

# 실무코드(코틀린 - 건우님 제공)

## 💡 Separate API

<br>

현재 사용되고 있는 보드 API를 분리할 예정

1. 투데이펫 게시글 (일상)
2. 실종신고 게시글
3. 함께해요 게시글

- 각각의 게시글에 필요한 값만 전달할 예정
- 투데이펫 게시글
  필요 API (Post, Patch, Get)
  \- Post (이미지 리스트, Content (String) 전달)
  \- Patch (이미지 리스트, Content (String) 전달) 
      예전 게시글 내용 (detail 변수) log.info로 출력
  \- Get (기존 정보로 일단 구현 - 직접 수정 예정)

---

## 💡 Alert

Entity

```kotlin
    fun modifyingAlertBoard(data: AlertDTO) {
        /** @desc 실종 정보 */
        this.requestedAt = data.missingDate
        this.requestedAt02 = data.missingTime
        this.requestedLocation = data.missingLocation
        this.phoneNumber = data.userPhone ?: ""

        /** 반려동물 정보 */
        this.animalName = data.user.animalName
        this.requestAnimalUser = data.missingAnimalKind
        this.breed = data.missingAnimalBreed
        this.requestGender = data.user.animalGender ?: ""
        this.animalNetralization = data.user.animalNeutralization
        this.animalSize = data.user.animalSize
        this.animalBirth = data.missingAnimalBirth

        /** @desc 글 정보 */
        this.requestContent = data.detail.content ?: ""
        this.pics = data.detail.images
    }
```

<br>

DTO

```kotlin
package com.cosmic.dangnyang.network.dto.v3.board

import com.cosmic.dangnyang.entity.Board
import java.time.LocalDateTime

/* 실종신고 게시글 DTO */

/** @desc Post DTO */
data class AlertDTO (

    var user: CommunityDTO.User,
    var detail: CommunityDTO.CommunityDetail,
    var userPhone: String? = "",

    /** @desc 실종 정보 */
    var missingDate: LocalDateTime? = null,
    var missingTime: LocalDateTime? = null,
    var missingLocation: String = "",

    /** @desc 반려동물 정보 */
    var missingAnimalKind: String = "",
    var missingAnimalBreed: String = "",
    var missingAnimalBirth: String = "",
)

/** Detail DTO */
class AlertDetail(
    var user: CommunityDTO.User,
    var kind : String,
    var detail : CommunityDTO.CommunityDetail,

    /** @desc 실종 정보 */
    var missingDate: LocalDateTime? = null,
    var missingTime: LocalDateTime? = null,
    var missingLocation: String = "",
    var userPhone: String? = "",

    /** @desc 반려동물 정보 */
    var missingAnimalKind: String = "",
    var missingAnimalBreed: String = "",
    var missingAnimalBirth: String = "",
) {
    companion object {
        fun fromEntity(board: Board, uid : String) : AlertDetail {
            return AlertDetail(
                kind = "실종신고",
                user = CommunityDTO.User.fromEntity(board.user),
                detail = CommunityDTO.CommunityDetail.fromEntity(board, uid),
                missingDate = board.requestedAt,
                missingTime = board.requestedAt02,
                missingLocation = board.requestedLocation ?: "",
                userPhone = board.phoneNumber,
                missingAnimalKind = board.requestAnimalUser,
                missingAnimalBreed = board.breed ?: "",
                missingAnimalBirth = board.animalBirth ?: ""
            )
        }
    }
}

/** Response DTO */
data class AlertResponseDTO (
    var id: Long? = null
) {
    object ModelMapper {
        fun entityToDto(form: Board): AlertResponseDTO {
            return AlertResponseDTO(
                id = form.id
            )
        }
    }
}
```

<br>Service

```kotlin
/* 실종신고 게시판 서비스 */

@Service
class AlertService (
    @Autowired private val userRecycleFn: UserRecycleFn,
    @Autowired private val boardRecycleFn: BoardRecycleFn,
    @Autowired private val ncpS3UploaderRecycleFn: NcpS3UploaderRecycleFn,
    @Autowired private val apiService: ApiService,
    @Autowired private val boardRepository: BoardRepository
        ) {

    /**
     * @param uid : 작성자
     * @param data : 게시글 정보
     * @param multipartFile : 이미지 파일
     * @desc 실종신고 게시글 업로드
     */
    @Transactional
    fun postAlertBoard(
        uid: String,
        data: AlertDTO,
        multipartFile: List<MultipartFile>
    ): AlertResponseDTO {

        val anUser = userRecycleFn.checkActiveUser(uid)
        userRecycleFn.validateUser(anUser, "alert")

        val aBoard: Board = try {
            Board(user = anUser).apply {
                kind = "실종신고"
                requestContent = data.detail.content ?: ""
                pics = data.detail.images
                requestedAt = data.missingDate
                requestedAt02 = data.missingTime
                requestedLocation = data.missingLocation
                phoneNumber = data.userPhone ?: ""
                animalName = data.user.animalName
                requestAnimalUser = data.missingAnimalKind
                breed = data.missingAnimalBreed
                requestGender = data.user.animalGender ?: ""
                animalNetralization = data.user.animalNeutralization
                animalSize = data.user.animalSize
                animalBirth = data.missingAnimalBirth
                createdAt = LocalDateTime.now()
            }
        } catch (e: Exception) {
            log.error("ALERT-004 : 실종신고 게시글 생성 에러 - $e, $uid")
            throw CommonException("ALERT-004", HttpStatus.BAD_REQUEST)
        }

        if (aBoard.kind != "실종신고") {
            apiService.serverErrorWebHook(
                "실종신고 글이 아닙니다.",
            CommonException("ALERT-004", HttpStatus.BAD_REQUEST))
        }

        ncpS3UploaderRecycleFn.upload(aBoard, multipartFile, uid, "실종신고", "alert")

        log.info("실종신고 게시글 생성 완료 - [ 작성자 : $uid, 글 번호 : $aBoard.id ]")

        return AlertResponseDTO.ModelMapper.entityToDto(aBoard)
    }

    /**
     * @param boardId : 글 번호
     * @param uid : 작성자
     * @param data : 게시글 정보
     * @param multipartFile : 이미지 파일
     * @desc 실종신고 게시글 수정
     */
    @Transactional
    fun patchAlertBoard (
        boardId: String,
        uid: String,
        data: AlertDTO,
        multipartFile: List<MultipartFile>
    ): AlertResponseDTO {

        val anUser = userRecycleFn.checkActiveUser(uid)
        val aBoard = boardRecycleFn.checkBoardStatus(boardId.toLong(), uid, false)

        boardRecycleFn.validateUserAndBoard(anUser, aBoard)

        if (aBoard.kind != "실종신고") {
            apiService.serverErrorWebHook(
                "실종신고 글이 아닙니다.",
                CommonException("ALERT-004", HttpStatus.BAD_REQUEST))
        }

        ncpS3UploaderRecycleFn.update(aBoard, multipartFile, uid, "실종신고", "alert")

        log.info("실종신고 게시글 수정 전 게시글 - [ {${aBoard.requestContent} ]")

        aBoard.modifyingAlertBoard(data)

        log.info("실종신고 게시글 수정 완료 - [ 작성자 : $uid, 글 번호 : $boardId ]")

        return AlertResponseDTO.ModelMapper.entityToDto(aBoard)
    }

    /**
     * @param boardId : 글 번호
     * @param uid : 작성자
     * @desc 실종신고 게시글 조회
     */
    fun getAlertBoard (
        boardId: String,
        uid: String
    ): AlertDetail {

        val anUser = userRecycleFn.checkActiveUser(uid)
        val aBoard = boardRecycleFn.checkBoardStatus(boardId.toLong(), uid, false)

        boardRecycleFn.validateUserAndBoard(anUser, aBoard)

        if (aBoard.kind != "실종신고") {
            apiService.serverErrorWebHook(
                "[ 보안 알림 ] 실종신고 게시글이 아닙니다 - ${aBoard.kind}",
                CommonException("ALERT-004", HttpStatus.BAD_REQUEST))
        }

        val result = try {
            boardRepository.findByIdAndCheckStatus(boardId.toLong(), false)
        } catch (e: Exception) {
            log.error("ALERT-002 : 실종신고 게시글 조회 실패 - [ 작성자 : $uid, 글 번호 : $boardId ]")
            throw CommonException("ALERT-002", HttpStatus.BAD_REQUEST)
        }

        log.info("실종신고 게시글 조회 성공 - [ 작성자 : $uid, 글 번호 : $boardId ]")

        return AlertDetail.fromEntity(aBoard, uid)
    }

    companion object {
        private val log: Logger = LogManager.getLogger(this.javaClass.name)
    }
}
```

<br>

Controller

```kotlin
/* 실종신고 게시판 컨트롤러 */

@RestController
@RequestMapping("/alert")
class AlertController (
    @Autowired private val alertService: AlertService
        ) {

    /**
     * @param multipartFile : 이미지 파일
     * @param data : 게시글 정보
     * @param uid : 작성자
     * @desc 실종신고 게시글 생성 API
     */
    @Auth(Auth.Role.USER)
    @PostMapping
    fun postAlertBoard(
        @RequestPart multipartFile: List<MultipartFile>,
        @RequestPart data: AlertDTO,
        @RequestAttribute("uid") uid: String
    ): ResponseEntity<AlertResponseDTO> {
        return ResponseEntity(alertService.postAlertBoard(uid, data, multipartFile), HttpStatus.CREATED)
    }

    /**
     * @param boardId : 글 번호
     * @param multipartFile : 이미지 파일
     * @param data : 수정할 게시글 정보
     * @param uid : 작성자
     * @desc 실종신고 게시글 수정 API
     */
    @Auth(Auth.Role.USER)
    @PatchMapping("/{boardId}")
    fun patchAlertBoard(
        @PathVariable boardId: String,
        @RequestPart multipartFile: List<MultipartFile>,
        @RequestPart data: AlertDTO,
        @RequestAttribute("uid") uid: String
    ): ResponseEntity<AlertResponseDTO> {
        return ResponseEntity(alertService.patchAlertBoard(boardId, uid, data, multipartFile), HttpStatus.OK)
    }

    /**
     * @param boardId : 글 번호
     * @param uid: 작성자
     * @desc 실종신고 게시글 단건 조회 API
     */
    @Auth(Auth.Role.USER)
    @GetMapping("/{boardId}")
    fun getAlertBoard(
        @PathVariable boardId: String,
        @RequestAttribute("uid") uid: String
    ): ResponseEntity<AlertDetail> {
        return ResponseEntity(alertService.getAlertBoard(uid, boardId), HttpStatus.OK)
    }
}
```

---

공통 검증 로직

Get은 2번쨰 if 문 전체를 뺴야하고

Patch API는 이 코드를 전체 다써야함 

```kotlin
    /* 유저 & 보드 검증 */
    fun validateUserAndBoard(user: User, board: Board) {

        if (user.grade != "정회원") {
            throw CommonException("${board.kind}-005 - 회원 등급 오류", HttpStatus.FORBIDDEN)
        }

        // Patch API 에서 씀
        if (board.kind != "${board.kind}") {
            log.error("${board.kind}-004 : ${board.kind} 게시글이 아닙니다 - ${board.kind}")
            throw CommonException("${board.kind}-004", HttpStatus.BAD_REQUEST)
        } else if (user.id != board.user.id) {
            log.error("${board.kind}-004 : 작성자가 아닙니다")
            throw CommonException("${board.kind}-011", HttpStatus.BAD_REQUEST)
        }
    }
```

<br>

CommunityDTO

```kotlin
class CommunityDTO {

    data class User (
            var uid : String?,

            var userName : String?,
            var userAgeRange : String?,
            var userGender : String?,

            var animalName : String?,
            var animal : String?,
            var animalProfile : String?,
            var animalGender : String?,
            var animalNeutralization : Boolean?,
            var animalSize : String?,

            var give : Int?,
            var take : Int?,

            var location : LocationResDTO?,
            var trustPoint : Int?
            ) {

        companion object {
            fun fromEntity(user : com.cosmic.dangnyang.entity.User) : User {
                return User(
                        uid = user.id,
                        userName = user.name,
                        userGender = user.gender,
                        userAgeRange = user.ageRange,

                        animalName = user.animals[0].name,
                        animal = user.animals[0].animal,
                        animalProfile = user.animals[0].profile,
                        animalGender = user.animals[0].gender,
                        animalNeutralization = user.animals[0].neutralization,
                        animalSize = user.animals[0].size,

                        give = user.give,
                        take = user.take,

                        location = user.geometry?.let { LocationResDTO.ModelMapper.entityToDto(it) },
                        trustPoint = user.trustPoint
                )
            }
        }
    }

    data class CommunityDetail (
        var user : User? = null,
        var modified : Boolean? = null,
        var content : String? = null,
        var images : List<String>? = null,
        var liked : Boolean? = null,
        var pushNotification : Boolean? = null,
        var comment : List<CommentDTO> = listOf(),
        var createdAt : LocalDateTime? = null,
    ) {
        companion object {
            fun fromEntity(board : Board, uid : String) : CommunityDetail {
                return CommunityDetail.run {
                    CommunityDetail(
                        user = User.fromEntity(board.user),
                        modified = (board.modifiedAt != null),
                        content = board.requestContent,
                        images = board.pics,
                        liked = board.boardAlreadyLike(uid),
                        pushNotification = board.pushUsers.contains(uid),
                        comment = board.comments.filter { it.activateComment() }.map { CommentDTO.ModelMapper.entityToDto(it) }.toList(),
                        createdAt = board.createdAt,
                    )
                }
            }
        }
    }

    class LifeDetail(
            var kind : String,
            var detail : CommunityDetail
    ) {
        companion object {
            fun fromEntity(board : Board, uid : String) : LifeDetail {
                return LifeDetail(
                        kind = "일상",
                        detail = CommunityDetail.fromEntity(board, uid)
                )
            }
        }
    }
}
```

<br>

### Entity

```kotlin
    fun modifyingTodayPetBoard(data: TodayPetDTO) {
        this.requestContent = data.detail.content ?: ""
        this.pics = data.detail.images
        this.modifiedAt = LocalDateTime.now()
    }

    fun modifyingTogetherBoard(data: TogetherDTO) {
        this.requestContent = data.detail.content ?: ""
        this.pics = data.detail.images
        this.modifiedAt = LocalDateTime.now()
    }

    fun modifyingAlertBoard(data: AlertDTO) {
        /** @desc 실종 정보 */
        this.requestedAt = data.missingDate
        this.requestedAt02 = data.missingTime
        this.requestedLocation = data.missingLocation
        this.phoneNumber = data.userPhone ?: ""

        /** 반려동물 정보 */
        this.animalName = data.user.animalName
        this.requestAnimalUser = data.missingAnimalKind
        this.breed = data.missingAnimalBreed
        this.requestGender = data.user.animalGender ?: ""
        this.animalNetralization = data.user.animalNeutralization
        this.animalSize = data.user.animalSize
        this.animalBirth = data.missingAnimalBirth

        /** @desc 글 정보 */
        this.requestContent = data.detail.content ?: ""
        this.pics = data.detail.images
        this.modifiedAt = LocalDateTime.now()
    }
```

<br>

### ImageRecycleFn

```kotlin
/** @desc 이미지 Recycle Function */

@Component
class NcpS3UploaderRecycleFn (
    @Autowired private val ncpS3Uploader: NcpS3Uploader,
    @Autowired private val apiService: ApiService
        ) {

    /**
     * @param aBoard : 게시글
     * @param multipartFile : 이미지 파일
     * @param boardKind : Web Hook 전송을 위한 게시판의 **한글명**
     * @desc 게시글의 입력받은 이미지 삭제 검증 로직
     */
    fun validateImages (
        aBoard: Board,
        multipartFile: List<MultipartFile>,
        boardKind: String
    ) {
        if (multipartFile.isNotEmpty()) {
            try {
                ncpS3Uploader.removeImages(aBoard.pics ?: listOf())
                aBoard.removePics()
            } catch (e: Exception) {
                apiService.serverErrorWebHook("$boardKind 게시판 이미지 삭제 실패", e)
            }
        }
    }

    /**
     * @param aBoard : 게시글
     * @param multipartFile : 이미지 파일
     * @param boardKind : Web Hook 전송을 위한 게시판의 **한글명**
     * @param boardCategory : 로그 기록을 위함, Error 코드에 쓰일 게시판 카테고리의 **영문명**
     * @desc 이미지 삭제 완료 후, 새로운 이미지 업데이트
     */
    fun updateImages (
        aBoard: Board,
        multipartFile: List<MultipartFile>,
        boardKind: String,
        boardCategory: String
    ) {

        if (multipartFile.isNotEmpty()) {
            try {
                ncpS3Uploader.removeImages(aBoard.pics ?: listOf())
                aBoard.removePics()
            } catch (e: Exception) {
                apiService.serverErrorWebHook("$boardKind 게시판 이미지 삭제 실패", e)
            }


            val newImages = try {
                ncpS3Uploader.uploadImages(multipartFile, "$boardCategory/${aBoard.id}")
            } catch (e: CommonException) {
                aBoard.removePics()
                val error: String = boardCategory.toUpperCase()
                log.error("$error-IMG-002 : $boardKind 게시판 이미지 수정 실패", e)
                throw CommonException("$error-IMG-002", HttpStatus.BAD_REQUEST)
            }
            aBoard.updatePics(newImages)
        }
    }

    companion object {
        private val log: Logger = LogManager.getLogger(this.javaClass.name)
    }
}
```

---

## 💡 Today Pet

<br>

### Controller

```kotlin
/* Today Pet Controller */

@RestController
@RequestMapping("/today")
class TodayPetController (
    @Autowired private val todayPetService: TodayPetService
        ) {

    /**
     * @param multipartFile : 이미지 파일
     * @param data : 게시글 정보
     * @param uid : 작성자
     * @desc 투데이펫 게시글 생성 API
     */
    @Auth(Auth.Role.USER)
    @PostMapping
    fun postTodayPetBoard(
        @RequestPart multipartFile: List<MultipartFile>,
        @RequestPart data: TodayPetDTO,
        @RequestAttribute("uid") uid: String,
    ) : ResponseEntity<TodayPetResponseDTO> {
        return ResponseEntity(todayPetService.postTodayPetBoard(uid, data, multipartFile), HttpStatus.CREATED)
    }

    /**
     * @param boardId : 글 번호
     * @param multipartFile : 이미지 파일
     * @param data : 수정할 게시글 정보
     * @param uid : 작성자
     * @desc 투데이펫 게시글 수정 API
     */
    @Auth(Auth.Role.USER)
    @PatchMapping("/{boardId}")
    fun patchTodayPetBoard(
        @PathVariable boardId: String,
        @RequestPart multipartFile: List<MultipartFile>,
        @RequestPart data: TodayPetDTO,
        @RequestAttribute("uid") uid: String,
    ) : ResponseEntity<TodayPetResponseDTO> {
        return ResponseEntity(todayPetService.patchTodayPetBoard(boardId ,uid, data, multipartFile), HttpStatus.OK)
    }

    /**
     * @param boardId : 글 번호
     * @param uid : 작성자
     * @desc 투데이펫 게시글 단건 조회 API
     */
    @Auth(Auth.Role.USER)
    @GetMapping("/{boardId}")
    fun getTodayPetBoard(
        @PathVariable boardId: String,
        @RequestAttribute("uid") uid: String
    ) : ResponseEntity<TodayPetDetail> {
        return ResponseEntity(todayPetService.getTodayPetBoard(uid, boardId), HttpStatus.OK)
    }
}
```

<br>

### DTO

```kotlin
/* 투데이펫 게시판 DTO */

/** @desc Post DTO */
data class TodayPetDTO (
    var user: CommunityDTO.User,
    var detail: CommunityDTO.CommunityDetail
)

/** @desc Detail DTO */
data class TodayPetDetail (
    var kind: String,
    var user: CommunityDTO.User,
    var detail: CommunityDTO.CommunityDetail
) {
    companion object {
        fun fromEntity(board: Board, uid: String) : TodayPetDetail {
            return TodayPetDetail(
                kind = "일상",
                user = CommunityDTO.User.fromEntity(board.user),
                detail = CommunityDTO.CommunityDetail.fromEntity(board, uid)
            )
        }
    }
}

/** @desc Response DTO */
data class TodayPetResponseDTO (
    var id: Long? = null
) {
    object ModelMapper {
        fun entityToDto(form: Board): TodayPetResponseDTO {
            return TodayPetResponseDTO(
                id = form.id
            )
        }
    }
}
```

<br>

### Service

추후 검증로직을 빼서 RecycleFn 으로 만들 예정

```kotlin
/* 투데이펫 게시판 서비스 */

@Service
class TodayPetService(
    @Autowired private val userRecycleFn: UserRecycleFn,
    @Autowired private val apiService: ApiService,
    @Autowired private val boardRecycleFn: BoardRecycleFn,
    @Autowired private val ncpS3UploaderRecycleFn: NcpS3UploaderRecycleFn
) {

    /**
     * @param uid : 작성자
     * @param data : 게시글 정보
     * @param multipartFile : 이미지 파일
     * @desc 투데이펫 게시글 생성
     */
    @Transactional
    fun postTodayPetBoard(
        uid: String,
        data: TodayPetDTO,
        multipartFile: List<MultipartFile>
    ): TodayPetResponseDTO {

        val anUser = userRecycleFn.checkActiveUser(uid)

        userRecycleFn.validateUser(anUser, "today")

        val aBoard: Board = try {
            Board(user = anUser).apply {
                kind = "일상"
                requestContent = data.detail.content ?: ""
                pics = data.detail.images
                createdAt = LocalDateTime.now()
            }
        } catch (e: Exception) {
            log.error("TODAY-004 : 투데이 게시글 생성 에러 - $e, $uid")
            throw CommonException("TODAY-004", HttpStatus.BAD_REQUEST)
        }

        ncpS3UploaderRecycleFn.upload(aBoard, multipartFile, uid,"투데이펫", "today")

        log.info("투데이 게시글 생성 완료 - [ 작성자 : $uid, 글 번호 : $aBoard.id ]")

        return TodayPetResponseDTO.ModelMapper.entityToDto(aBoard)
    }

    /**
     * @param uid : 작성자
     * @param data : 게시글 정보
     * @param multipartFile : 이미지 파일
     * @desc 투데이펫 게시글 수정
     */
    @Transactional
    fun patchTodayPetBoard(
        boardId: String,
        uid: String,
        data: TodayPetDTO,
        multipartFile: List<MultipartFile>
    ): TodayPetResponseDTO {

        val anUser = userRecycleFn.checkActiveUser(uid)
        val aBoard = boardRecycleFn.checkBoardStatus(boardId.toLong(), uid, false)

        boardRecycleFn.validateUserAndBoard(anUser, aBoard)

        if (aBoard.kind != "투데이펫") {
            apiService.serverErrorWebHook(
                "[ 보안 알림 ] 투데이펫 게시글이 아닙니다 - ${aBoard.kind}",
                CommonException("TODAY-004", HttpStatus.BAD_REQUEST)
            )
        }

        ncpS3UploaderRecycleFn.update(aBoard, multipartFile, uid,"투데이펫", "today")

        log.info("투데이펫 게시글 수정 전 게시글 - [ ${aBoard.requestContent} ]")

        aBoard.modifyingTodayPetBoard(data)

        log.info("투데이펫 게시글 수정 완료 - [ 작성자 : $uid, 글번호 : $boardId")

        return TodayPetResponseDTO.ModelMapper.entityToDto(aBoard)
    }

    /**
     * @param boardId : 글번호
     * @param uid : 작성자
     * @desc 투데이펫 게시글 조회
     */
    fun getTodayPetBoard(
        boardId: String,
        uid: String
    ): TodayPetDetail {

        val anUser = userRecycleFn.checkActiveUser(uid)
        val aBoard = boardRecycleFn.checkBoardStatus(boardId.toLong(), uid, false)

        boardRecycleFn.validateUserAndBoard(anUser, aBoard)

        if (aBoard.kind != "일상") {
            apiService.serverErrorWebHook(
                " [ 보안 알림 ] 투데이펫 게시글이 아닙니다 - ${aBoard.kind}",
                CommonException("TODAY-004", HttpStatus.BAD_REQUEST)
            )
        }

        val result = try {
            TodayPetDetail.fromEntity(aBoard, uid)
        } catch (e: Exception) {
            log.error("TODAY-002 : 투데이펫 게시글 데이터 매핑 실패 - [ 작성자 : $uid, 글 번호 : $boardId")
        }

        log.info("투데이펫 게시글 조회 성공 - [ 작성자 : $uid, 글번호 : $boardId ]")

        return result as TodayPetDetail
    }

    companion object {
        private val log: Logger = LogManager.getLogger(this.javaClass.name)
    }

```

<br>

### Entity

```kotlin
    fun modifyingTodayPetBoard(data : TodayPetDTO) {
        this.requestContent = data.content
    }
```

---

## 💡 Together

### DTO

```kotlin
/* 함께해요 게시판 DTO */

/** @desc Post DTO */
data class TogetherDTO (
    var user: CommunityDTO.User,
    var detail: CommunityDTO.CommunityDetail,
)

/** @desc Detail DTO */
class TogetherDetail(
    var kind: String,
    var user: CommunityDTO.User,
    var detail: CommunityDTO.CommunityDetail
) {
    companion object {
        fun fromEntity(board: Board, uid: String) : TogetherDetail {
            return TogetherDetail(
                kind = "함께해요",
                detail = CommunityDTO.CommunityDetail.fromEntity(board, uid),
                user = CommunityDTO.User.fromEntity(board.user)
            )
        }
    }
}

/** Response DTO */
data class TogetherResponseDTO (
    var id: Long? = null
) {
    object ModelMapper {
        fun entityToDto(form: Board): TogetherResponseDTO {
            return TogetherResponseDTO(
                id = form.id
            )
        }
    }
}
```

<br>

### Controller

```kotlin
package com.cosmic.dangnyang.Controller.v4

import com.cosmic.dangnyang.Service.v3.board.TogetherService
import com.cosmic.dangnyang.config.interceptor.Auth
import com.cosmic.dangnyang.network.dto.v3.board.TogetherDTO
import com.cosmic.dangnyang.network.dto.v3.board.TogetherDetail
import com.cosmic.dangnyang.network.dto.v3.board.TogetherResponseDTO
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.http.HttpStatus
import org.springframework.http.ResponseEntity
import org.springframework.web.bind.annotation.*
import org.springframework.web.multipart.MultipartFile

/* 함께해요 게시판 컨트롤러 */

@RestController
@RequestMapping("/together")
class TogetherController (
    @Autowired private val togetherService: TogetherService
        ) {

    /**
     * @param multipartFile : 이미지 파일
     * @param data : 게시글 정보
     * @desc 함께해요 게시글 생성 API
     */
    @Auth(Auth.Role.USER)
    @PostMapping
    fun postTogetherBoard(
        @RequestPart multipartFile: List<MultipartFile>,
        @RequestPart data: TogetherDTO,
        @RequestAttribute("uid") uid: String
    ): ResponseEntity<TogetherResponseDTO> {
        return ResponseEntity(togetherService.postTogetherBoard(uid, data, multipartFile), HttpStatus.CREATED)
    }

    /**
     * @param boardId : 글 번호
     * @param multipartFile : 이미지 파일
     * @param data : 수정할 게시글 정보
     * @param uid : 작성자
     * @desc 함께해요 게시글 수정 API
     */
    @Auth(Auth.Role.USER)
    @PatchMapping("/{boardId}")
    fun patchTogetherBoard(
        @PathVariable boardId: String,
        @RequestPart multipartFile: List<MultipartFile>,
        @RequestPart data: TogetherDTO,
        @RequestAttribute("uid") uid: String
    ): ResponseEntity<TogetherResponseDTO> {
        return ResponseEntity(togetherService.patchTogetherBoard(boardId, uid, data, multipartFile), HttpStatus.OK)
    }

    @Auth(Auth.Role.USER)
    @GetMapping("/{boardId}")
    fun getTogetherBoard(
        @PathVariable boardId: String,
        @RequestAttribute("uid") uid: String
    ): ResponseEntity<TogetherDetail> {
        return ResponseEntity(togetherService.getTogetherBoard(uid, boardId), HttpStatus.OK)
    }
}
```

<br>

### Service

```kotlin
/* 함께해요 게시판 서비스 */

@Service
class TogetherService (
    @Autowired private val userRecycleFn: UserRecycleFn,
    @Autowired private val boardRecycleFn: BoardRecycleFn,
    @Autowired private val ncpS3UploaderRecycleFn: NcpS3UploaderRecycleFn,
    @Autowired private val apiService: ApiService,
    @Autowired private val boardRepository: BoardRepository
        ) {

    /**
     * @param uid : 작성자
     * @param data : 게시글 정보
     * @param multipartFile : 이미지 파일
     * @desc 함께해요 게시글 업로드
     */
    @Transactional
    fun postTogetherBoard(
        uid: String,
        data: TogetherDTO,
        multipartFile: List<MultipartFile>
    ): TogetherResponseDTO {

        val anUser = userRecycleFn.checkActiveUser(uid)

        userRecycleFn.validateUser(anUser, "together")

        val aBoard: Board = try {
            Board(user = anUser).apply {
                kind = "함께해요"
                requestContent = data.detail.content ?: ""
                pics = data.detail.images
                createdAt = LocalDateTime.now()
            }
        } catch (e: Exception) {
            log.error("TOGETHER-004 : 함께해요 게시글 생성 에러 - $e, $uid")
            throw CommonException("TOGETHER-004", HttpStatus.BAD_REQUEST)
        }

        if (aBoard.kind != "함께해요") {
            apiService.serverErrorWebHook(
                "함께해요 글이 아닙니다.",
                CommonException("TOGETHER-004", HttpStatus.BAD_REQUEST)
            )
        }

        ncpS3UploaderRecycleFn.upload(aBoard, multipartFile, uid, "함께해요", "together")

        log.info("함께해요 게시글 생성 완료 - [ 작성자 : $uid, 글 번호 : $aBoard.id ]")

        return TogetherResponseDTO.ModelMapper.entityToDto(aBoard)
    }

    /**
     * @param boardId : 글 번호
     * @param uid : 작성자
     * @param data : 게시글 정보
     * @pram multipartFile : 이미지 파일
     * @desc 함께해요 게시글 수정
     */
    @Transactional
    fun patchTogetherBoard(
        boardId: String,
        uid: String,
        data: TogetherDTO,
        multipartFile: List<MultipartFile>
    ): TogetherResponseDTO {

        val anUser = userRecycleFn.checkActiveUser(uid)
        val aBoard = boardRecycleFn.checkBoardStatus(boardId.toLong(), uid, false)

        boardRecycleFn.validateUserAndBoard(anUser, aBoard)

        if (aBoard.kind != "함께해요") {
            apiService.serverErrorWebHook(
                "함께해요 글이 아닙니다.",
                CommonException("TOGETHER-004", HttpStatus.BAD_REQUEST)
            )
        }

        ncpS3UploaderRecycleFn.update(aBoard, multipartFile, uid,"함께해요", "together")

        log.info("함께해요 게시글 수정 전 게시글 - [ {${aBoard.requestContent}} ]")

        aBoard.modifyingTogetherBoard(data)

        log.info("함께해요 게시글 수정 완료 = [ 작성자 : $uid, 글 번호 : $boardId ]")

        return TogetherResponseDTO.ModelMapper.entityToDto(aBoard)
    }

    /**
     * @param boardId : 글 번호
     * @param uid : 작성자
     */
    fun getTogetherBoard(
        boardId: String,
        uid: String
    ): TogetherDetail {

        val anUser  = userRecycleFn.checkActiveUser(uid)
        val aBoard = boardRecycleFn.checkBoardStatus(boardId.toLong(), uid, false)

        boardRecycleFn.validateUserAndBoard(anUser, aBoard)

        if (aBoard.kind != "함께해요") {
            apiService.serverErrorWebHook(
                "[ 보안 알림 ] 함께해요 게시글이 아닙니다 - ${aBoard.kind}",
                CommonException("TOGETHER-004", HttpStatus.BAD_REQUEST)
            )
        }

        val result = try {
            boardRepository.findByIdAndCheckStatus(boardId.toLong(), false)
        } catch (e: Exception) {
            log.error("TOGETHER-002 : 함께해요 게시글 조회 실패 - [ 작성자 : $uid, 글 번호 : $boardId ]")
            throw CommonException("TOGETHER-002", HttpStatus.BAD_REQUEST)
        }

        log.info("함께해요 게시글 조회 성공 - [ 작성자 : $uid, 글 번호 : $boardId ] ")

        return TogetherDetail.fromEntity(aBoard, uid)

    }

    companion object {
        private val log: Logger = LogManager.getLogger(this.javaClass.name)
    }
```

