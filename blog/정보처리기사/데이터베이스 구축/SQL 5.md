태그: #정보처리기사 
연결문서: [SQL 6](SQL%206.md)

# 02. 절차형 SQL

## 01. 절차형 SQL

### 1) 절차형 SQL

#### 1. 절차형 SQL의 개념
- SQL도 일반 프로그램 언어와 유사하게 절차 지향적인 프로그램이 가능함
- SQL문의 연속적인 실행이나 조건에 따른 분기, 반복 등의 제어를 활용하여 다양한 기능을 수행하는 저장 모듈을 생성하고 쉽게 활용할 수 있음
- 절차형 SQL은 데이터베이스 작업의 높은 효율성과 생산성을 확보할 수 있게 해줌
- 절차형 SQL에는 프로시저(Procedure), 사용자 정의 함수(User Define Function) 및 트리거(Trigger)가 있음

#### 2. 절차형 SQL의 특징
- DBMS에서 직접 실행함
- BEGIN/END의 블록화된 구조로 되어 있어 각 기능별로 모듈화가 가능함
- 단일 SQL 문장으로는 실행하기 어려운 연속적인 작업을 처리하는 데에 적합함
- 비즈니스 로직을 캡슐화하여 데이터 관리를 단순화하고 무결성 유지 및 일관성 보장이 가능함
- 일련의 작업에 필요한 데이터를 DBMS 내부에서 직접 처리하기 때문에 일반적으로 입출력 데이터가 적음
- 다른 프로그램 언어에 비해 작업의 효율성이 낮은 편에 속함
- DBMS별 차이가 있어서 다른 환경에 이식하는 경우 수정 및 재컴파일이 필요함
- 절차형 SQL들은 필수 구성 요소만 갖추면 정상적인 컴파일도 가능하고 실행도 가능함

<br>

### 2) 절차형 SQL의 필수 구성 요소
1. DECLARE(선언)
    - 대상의 이름 및 변수 등을 선언, 대상이 되는 프로시저, 사용자 정의 함수 등을 정의함
2. BEGIN(시작)
    - 실행 시 시점, 프로시저, 사용자 정의 함수가 시작되는 시작점
3. END(끝)
    - 실행 시 종점, 프로시점, 사용자 정의 함수가 실행되는 종료점

<br>

---

<br>

## 02. 프로시저(Procedure)

### 1) 프로시점의 개념
- 절차형 SQL을 활용하여 특정 기능을 수행할 수 있는 트랜잭션 언어
- 프로시저는 호출하여 실행되며, 일련의 SQL 작업을 포함하는 데이터 조작어(DML)를 수행하는 것이 일반적
- 시스템에서의 매일 반복되는 작업, 일련의 배치 작업 등을 프로시저를 사용하여 관리하고 주기적으로 수행하기도 함

<br>

### 2) 프로시저의 구성
1. DECLARE
    - 프로시저의 명칭, 변수와 인수 그리고 그에 대한 데이터 타입을 정의하는 선언부
2. BEGIN/END
    - 프로시저의 시작과 종료를 표현하는 데 필수적
    - BEGIN/END를 쌍으로 이루어 추가하므로 블록을 구성함
    - 다수 실행을 제어하는 기본적 단위가 되며 논리적 프로세스를 구성함
3. CONTROL
    - 기본적으로는 순차적으로 처리함
    - 특정 비교 조건에 따라 참인 블록 또는 문장을 실행하거나, 다른 조건에 맞는 블록 또는 문장을 실행함
    - 조건에 따라 반복을 수행할 수도 있음
4. SQL
    - DQL(SELECT), DML(INSERT, UPDATE, DELETE)을 주로 사용함
    - DDL은 자주 사용하지는 않으나 가끔은 TRUNCATE를 사용하기도 함
5. EXCEPTION
    - BEGIN ~ END절에서 실행되는 SQL문이 실행될 대 예외 발생 시 예외 처리 방법을 정의하는 처리부
6. TRANSACTION
    - 프로시저에서 수행된 DML 수행 내역의 DBMS의 적용 또는 취소 여부를 결정하는 처리부
    - 일반 SQL과 동일하게 최종 COMMIT/ROLLBACK 시점 이후부터 실행된 DML의 적용/취소를 수행함

<br>

### 3) 프로시저 호출문 작성

#### 1. 프로시저 호출문의 형식

```sql
SQL> EXECUTE [프로시저명] (매개변수1, 매개변수2, ...);
```

#### 2. 프로시저 호출의 특징
- 작성된 프로시저는 외부 호출을 통해서 실행됨
- 응용 프로그램에서 호출하거나 내부 스케줄러에 의해 배치 작업을 수행하는 경우 등에 호출되어 프로시저가 사용됨
- SQL 명령어를 활용하여 작성된 프로시저를 호출함
- SQL TOOL을 활용하여 직접 실행시키는 경우에는 EXECUTE나 EXEC를 실행하여 프로시저를 실행함
- 데이터 유형의 경우 자동 변환이 되어도 별도 오류가 발생하지 않는 경우가 많지만 가급적 프로시저에서 선언한 데이터 타입과 동일하게 입출력 변수를 넣어서 실행시킴
- SQL TOOL 등을 사용하지 않고 응용 프로그램이나 다른 프로시저 등에서 호출 시에는 프로그램에 따라 별도 명령어 없이 "@프로시저명" 또는 프로시저 명칭만 사용하여 호출이 가능함

<br>

---

<br>

## 03. 사용자 정의 함수(User Define Function)

### 1) 사용자 정의 함수의 개념
- 프로시저와 동일하게 절차형 SQL을 활용하여 일련의 연산 처리 결과를 단일 값으로 반환할 수 있는 절차형 SQL
- DBMS에서 제공되는 공통적 함수 이외에 사용자가 직접 정의하고 작성함
- 사용자 정의 함수의 호출을 통해 실행되며, 반환되는 단일 값을 조회 또는 삽입, 수정 작업에 이용하는 것이 일반적
- 기본적인 개념 및 사용법, 문법 등은 상기 언급된 프로시저와 동일하며, 종료 시 단일 값을 반환한다는 것이 프로시저와의 가장 큰 차이점

<br>

### 2) 사용자 정의 함수의 구성
- 기본적인 상항은 프로시저와 동일하고 반환 부분만 프로시저와 다름
- CREATE 명령어로 DBMS 내에 사용자 정의 함수 생성이 가능함
- 사용자 정의 함수에서만 RETURN 명령을 사용함
- RETURN 명령을 통해 사용자 정의 함수 종료 시 사용자 정의 함수를 호출한 쿼리에 반환하는 단일 값을 정의함

<br>

### 3) 사용자 정의 함수 작성
1. 사용자 정의 함수의 변수 선언
    - 사용자 정의 함수의 외부와 연동되어야 하는 입력 변수를 선언 및 활용함
    - 사용자 정의 함수의 내부에서 생성하고 활용되어야 하는 변수를 선언 및 활용함
2. 사용자 정의 함수의 코드 작성
    - 설계한 데이터 프로세스를 중심으로 코드를 작성함
    - 가독성 확보 및 추후 수정 등의 과정에 대비하여 줄 바꿈에 유의하며 작성함
    - 조건, 반복, 분기 등의 데이터 흐름을 기반으로 코드를 작성함
3. 예외 처리 구현
    - 설계한 내용을 바탕으로 사용자 정의 함수 내부에서 사용되는 SQL문의 예외 발생 상황의 코드를 작성함
    - 발생 가능한 상황별 예외를 정의하고 처리 방안을 작성함
4. 코딩 규칙 확인
    - 소스 가독성을 높이기 위한 줄 바꿈이나 내외부 변수 사용 시의 변수 명명 방법, 주석문 추가 등을 준수하였는지 확인함

<br>

### 4) 사용자 정의 함수를 컴파일함
- 사용자 정의 함수를 컴파일함
- 컴파일 이후 DBMS에 반영되고 사용 가능함
- 에러가 발생하는 경우, 메시지를 참조하여 원인 해결 후 재컴파일함
- 프로시저와 동일하게 발생하는 메시지를 참조하여 원인을 해결함

<br>

### 5) 사용자 정의 함수 호출 쿼리 형식
1. 사용자 정의 함수 결과 값을 데이터 질의어에 활용

```sql
SQL> SELECT [사용자정의_함수명] (매개변수1, 매개변수2, ...)
    FROM 테이블명;
```

2. 사용자 정의 함수 결과 값을 데이터 조작어에 직접 적용

```sql
SQL> UPDATE [테이블명] SET [필드명] =
    [사용자정의함수] (매개변수1, ...) WHERE 조건...;
```

<br>

---

<br>

## 04. 트리거(Trigger)

### 1) 트리거의 정의
- 특정 테이블에 삽입, 수정, 삭제 등의 데이터 변경 이벤트가 발생하면 DBMS에서 자동적으로 수행되는 절차형 SQL
- 이벤트는 전체 트랜잭션 대상과 각행에 의해 발생되는 경우 모두를 포함할 수 있으며 테이블과 뷰, 데이터베이스 작업을 대상으로 정의할 수 있음

<br>

### 2) 트리거의 목적
- 특정 테이블에 대한 데이터 변경을 시작점으로 설정하고, 그와 관련된 작업을 자동적으로 수행하기 위해 트리거를 사용함
- 데이터베이스 시스템에서 삽입, 갱신, 삭제 등의 이벤트가 발생할 때마다 관련 작업이 자동으로 수행되는 절차형 SQL
- 일반적으로 이벤트와 관련된 테이블의 데이터 삽입, 추가, 삭제 작업을 DBMS가 자동적으로 실행시키는 데 활용되나, 데이터의 무결성 유지 및 로그 메시지 출력 등의 별도 처리를 위해 트리거를 사용하기도 함

<br>

### 3) 트리거의 구성
- 트리거는 프로시저나 사용자 정의 함수와 구성은 동일함
- 트리거는 사용자 정의 함수처럼 RETURN을 사용하지 않음
- DML을 주된 목적으로 한다는 점에서는 프로시저와 유사하나, 이벤트 명령어를 통해 트리거 실행을 위한 이벤트를 인지한다는 점과 외부 변수의 입출력이 없다는 점이 프로시저나 사용자 정의 함수와 다름

<br>

### 4) 트리거 작성 시 유의 사항
1. 데이터 제어어 사용 불가
    - 트리거 내에는 COMMIT, ROLLBACK 등의 DCL을 사용할 수 없음
    - AUTO COMMIT을 하는 결과와 같음
    - 트리거 내에 COMMIT이나 ROLLBACK을 사용하고 컴파일하면 오류가 발생하는 것을 볼 수 있음
    - 트리거 내에서 다른 프로시저를 호출하는 것도 가능한데, 해당 프로시저 내에 COMMIT이 포함되어 있다면 오류가 발생함
2. 오류 주의
    - 트리거 실행 중 오류가 발생하게 되면 트리거 실행의 원인을 제공한 데이터 작업에도 영향을 주는 경우가 많음
    - 특정 테이블에 데이터를 추가한 후 발생하는 트리거에서 오류가 발생할 경우에는 트리거 이후의 작업이 진행되지 않는 것뿐만 아니라, 더 나아가 데이터가 추가되지 않음
    - 결국 트랜잭션을 합치는 과정에서 더 높은 무결성 및 품질을 요구한다고 볼 수 있으므로 주의가 필요함